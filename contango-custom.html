<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contango Direct Interface - Custom Positions</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Mono:wght@700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #2d1b3d 100%);
      font-family: 'JetBrains Mono', monospace;
      color: #e0e6ff;
      padding: 40px 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    input, button, select {
      font-family: 'JetBrains Mono', monospace;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #00ffaa !important;
    }

    button {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 255, 170, 0.3);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .loading {
      animation: pulse 1.5s ease-in-out infinite;
    }

    .header {
      text-align: center;
      margin-bottom: 50px;
      animation: slideIn 0.6s ease-out;
    }

    .title {
      font-family: 'Space Mono', monospace;
      font-size: 3.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, #00ffaa, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      letter-spacing: -2px;
    }

    .subtitle {
      color: #8b93b5;
      font-size: 0.9rem;
      letter-spacing: 4px;
      text-transform: uppercase;
    }

    .divider {
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #00ffaa, #00d4ff);
      margin: 20px auto;
    }

    .card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 255, 170, 0.2);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .wallet-card {
      animation: slideIn 0.7s ease-out;
    }

    .form-card {
      padding: 40px;
      animation: slideIn 0.8s ease-out;
    }

    .connect-btn {
      background: linear-gradient(135deg, #00ffaa, #00d4ff);
      color: #0a0e27;
      border: none;
      padding: 16px 40px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      width: 100%;
    }

    .wallet-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .wallet-label {
      font-size: 0.75rem;
      color: #8b93b5;
      margin-bottom: 5px;
    }

    .wallet-address {
      font-size: 1rem;
      font-weight: 600;
      color: #00ffaa;
    }

    .wallet-type {
      font-size: 0.8rem;
      color: #8b93b5;
      margin-top: 3px;
    }

    .disconnect-btn {
      background: rgba(255, 255, 255, 0.05);
      color: #e0e6ff;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .form-title {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #e0e6ff;
      font-weight: 600;
    }

    .form-subtitle {
      font-size: 0.85rem;
      color: #8b93b5;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 0.85rem;
      color: #8b93b5;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-help {
      display: block;
      font-size: 0.75rem;
      color: #5a5f7d;
      margin-top: 4px;
      font-style: italic;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 14px 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #e0e6ff;
      font-size: 0.95rem;
    }

    .form-select {
      cursor: pointer;
    }

    .form-input::placeholder {
      color: #5a5f7d;
    }

    .form-input.address-input {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
    }

    .token-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 640px) {
      .token-grid {
        grid-template-columns: 1fr;
      }
    }

    .section-title {
      font-size: 1.1rem;
      color: #00ffaa;
      margin: 30px 0 20px 0;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .submit-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #00ffaa, #00d4ff);
      color: #0a0e27;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-top: 10px;
    }

    .submit-btn:disabled {
      background: rgba(255, 255, 255, 0.1);
      color: #8b93b5;
    }

    .alert {
      margin-top: 20px;
      padding: 14px;
      border-radius: 10px;
      font-size: 0.9rem;
    }

    .alert-error {
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid rgba(255, 68, 68, 0.3);
      color: #ff6b6b;
    }

    .alert-success {
      background: rgba(0, 255, 170, 0.1);
      border: 1px solid rgba(0, 255, 170, 0.3);
      color: #00ffaa;
    }

    .alert-info {
      background: rgba(0, 170, 255, 0.1);
      border: 1px solid rgba(0, 170, 255, 0.3);
      color: #00aaff;
    }

    .tx-label {
      font-size: 0.75rem;
      color: #8b93b5;
      margin-bottom: 5px;
    }

    .tx-link {
      color: #00ffaa;
      font-size: 0.85rem;
      word-break: break-all;
      text-decoration: none;
    }

    .tx-link:hover {
      text-decoration: underline;
    }

    .info-card {
      margin-top: 30px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      font-size: 0.8rem;
      color: #8b93b5;
      animation: slideIn 0.9s ease-out;
    }

    .info-card div {
      margin-bottom: 8px;
    }

    .info-card strong {
      color: #e0e6ff;
    }

    .disclaimer {
      margin-top: 20px;
      padding: 16px;
      background: rgba(255, 200, 0, 0.05);
      border: 1px solid rgba(255, 200, 0, 0.2);
      border-radius: 10px;
      font-size: 0.8rem;
      color: #ffc857;
      text-align: center;
      animation: slideIn 1s ease-out;
    }

    .example-box {
      background: rgba(0, 170, 255, 0.05);
      border: 1px solid rgba(0, 170, 255, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      font-size: 0.85rem;
      color: #8b93b5;
    }

    .example-box strong {
      color: #00aaff;
    }

    .example-box code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      color: #00ffaa;
      font-size: 0.8rem;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 25px 0;
    }

    .metric-card {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
    }

    .metric-label {
      font-size: 0.75rem;
      color: #8b93b5;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: #00ffaa;
    }

    .metric-value.warning {
      color: #ffc857;
    }

    .metric-value.danger {
      color: #ff6b6b;
    }

    .metric-subtext {
      font-size: 0.7rem;
      color: #5a5f7d;
      margin-top: 4px;
    }

    .balance-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: rgba(0, 255, 170, 0.05);
      border: 1px solid rgba(0, 255, 170, 0.2);
      border-radius: 8px;
      margin-top: 8px;
      font-size: 0.85rem;
    }

    .balance-label {
      color: #8b93b5;
    }

    .balance-value {
      color: #00ffaa;
      font-weight: 600;
    }

    .preset-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .preset-btn {
      padding: 12px 16px;
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
      color: #00d4ff;
      font-size: 0.85rem;
      font-weight: 600;
      text-align: center;
    }

    .preset-btn:hover:not(:disabled) {
      background: rgba(0, 212, 255, 0.2);
      border-color: rgba(0, 212, 255, 0.5);
    }

    .approval-section {
      margin: 20px 0;
      padding: 16px;
      background: rgba(255, 200, 0, 0.05);
      border: 1px solid rgba(255, 200, 0, 0.2);
      border-radius: 10px;
    }

    .approval-btn {
      width: 100%;
      padding: 14px;
      background: rgba(255, 200, 0, 0.2);
      border: 1px solid rgba(255, 200, 0, 0.4);
      border-radius: 8px;
      color: #ffc857;
      font-size: 0.95rem;
      font-weight: 600;
      margin-top: 10px;
    }

    .input-with-max {
      display: flex;
      gap: 8px;
    }

    .input-with-max input {
      flex: 1;
    }

    .max-btn {
      padding: 0 20px;
      background: rgba(0, 255, 170, 0.1);
      border: 1px solid rgba(0, 255, 170, 0.3);
      border-radius: 8px;
      color: #00ffaa;
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .max-btn:hover:not(:disabled) {
      background: rgba(0, 255, 170, 0.2);
    }

    .leverage-badge {
      display: inline-block;
      padding: 6px 14px;
      background: linear-gradient(135deg, #00ffaa, #00d4ff);
      color: #0a0e27;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      margin-left: 10px;
    }

    .network-selector {
      margin-bottom: 20px;
    }

    .network-select {
      width: 100%;
      padding: 14px 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 170, 0.3);
      border-radius: 10px;
      color: #e0e6ff;
      font-size: 0.95rem;
      font-family: 'JetBrains Mono', monospace;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .network-select:hover {
      border-color: rgba(0, 255, 170, 0.5);
    }

    .network-select:focus {
      outline: none;
      border-color: #00ffaa;
      box-shadow: 0 0 10px rgba(0, 255, 170, 0.3);
    }

    .network-info {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      font-size: 0.8rem;
      color: #8b93b5;
    }

    .network-status {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #00ffaa;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    .network-status.disconnected {
      background: #5a5f7d;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.6;
        transform: scale(1.1);
      }
    }

    .hidden {
      display: none;
    }

    /* Range slider styling */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 8px;
      background: rgba(0, 255, 170, 0.2);
      border-radius: 5px;
      outline: none;
      padding: 0;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #00ffaa, #00d4ff);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 10px rgba(0, 255, 170, 0.5);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #00ffaa, #00d4ff);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
    }

    input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 10px rgba(0, 255, 170, 0.5);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 class="title">CONTANGO</h1>
      <p class="subtitle">Custom Position Builder</p>
      <div class="divider"></div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info" style="animation: slideIn 0.6s ease-out;">
      <strong>üéØ Create Custom Positions:</strong> This interface lets you open positions with any token pair and money market combination across multiple chains. Specify your base token, quote token, and money market to create positions not available in the standard UI.
    </div>

    <!-- Network & Wallet Connection -->
    <div class="card wallet-card">
      <!-- Network Selector -->
      <div class="network-selector">
        <label class="wallet-label" style="margin-bottom: 8px; display: block;">SELECT NETWORK</label>
        <select id="networkSelect" class="network-select" onchange="switchNetwork()">
          <option value="">Loading networks...</option>
        </select>
        <div class="network-info">
          <span class="network-status disconnected" id="networkStatus"></span>
          <span id="networkInfo">Select a network to begin</span>
        </div>
      </div>

      <div id="connectSection">
        <button class="connect-btn" onclick="connectWallet()" id="connectBtn">Connect Wallet</button>
        <div id="initializingMsg" class="hidden" style="margin-top: 12px; text-align: center; font-size: 0.85rem; color: #8b93b5;">
          <div class="loading">Initializing wallet connection...</div>
        </div>
      </div>
      <div id="walletSection" class="hidden">
        <div class="wallet-info">
          <div style="flex: 1;">
            <div class="wallet-label">CONNECTED</div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <div class="wallet-address" id="walletAddress"></div>
              <button class="max-btn" onclick="copyAddress()" style="padding: 6px 12px; font-size: 0.75rem;" title="Copy address">
                üìã
              </button>
            </div>
            <div class="wallet-type" id="walletType"></div>
            <div class="wallet-type" id="walletBalance" style="color: #00ffaa; margin-top: 4px;">Balance: --</div>
          </div>
          <button class="disconnect-btn" onclick="disconnectWallet()">Disconnect</button>
        </div>
      </div>
    </div>

    <!-- Main Form -->
    <div class="card form-card">
      <h2 class="form-title">Build Custom Position</h2>
      <p class="form-subtitle">
        Define your position by specifying the token addresses and money market. The instrument symbol will be automatically generated from your inputs.
      </p>

      <!-- Preset Configurations -->
      <div class="section-title">Quick Presets</div>
      <div class="preset-buttons">
        <button class="preset-btn" onclick="loadPreset('dai-usds')">DAI/USDS Loop</button>
        <button class="preset-btn" onclick="loadPreset('weth-usdc')">WETH/USDC</button>
        <button class="preset-btn" onclick="loadPreset('cbeth-usdc')">cbETH/USDC</button>
        <button class="preset-btn" onclick="clearForm()">Clear All</button>
      </div>

      <div class="section-title">Token Pair Configuration</div>
      
      <div class="token-grid">
        <!-- Base Token -->
        <div class="form-group">
          <label class="form-label">Base Token Address *</label>
          <input type="text" id="baseToken" class="form-input address-input" placeholder="0x..." onchange="loadTokenInfo('base')" />
          <span class="form-help">The token you want to long/short (e.g., WETH)</span>
          <div id="baseBalance" class="balance-display hidden">
            <span class="balance-label">Your Balance:</span>
            <span class="balance-value">--</span>
          </div>
        </div>

        <!-- Quote Token -->
        <div class="form-group">
          <label class="form-label">Quote Token Address *</label>
          <input type="text" id="quoteToken" class="form-input address-input" placeholder="0x..." onchange="loadTokenInfo('quote')" />
          <span class="form-help">The collateral/pricing token (e.g., USDC)</span>
          <div id="quoteBalance" class="balance-display hidden">
            <span class="balance-label">Your Balance:</span>
            <span class="balance-value">--</span>
          </div>
        </div>
      </div>

      <!-- Money Market -->
      <div class="form-group">
        <label class="form-label">Money Market ID *</label>
        <select id="moneyMarket" class="form-select">
          <option value="">Select Money Market</option>
          <option value="aave">Aave</option>
          <option value="compound">Compound</option>
          <option value="moonwell">Moonwell</option>
          <option value="sonne">Sonne</option>
          <option value="seamless">Seamless</option>
          <option value="custom">Custom (Enter ID)</option>
        </select>
        <span class="form-help">The lending protocol to use for position</span>
      </div>

      <!-- Custom Market ID (shown when custom is selected) -->
      <div id="customMarketSection" class="form-group hidden">
        <label class="form-label">Custom Market ID</label>
        <input type="text" id="customMarketId" class="form-input" placeholder="Enter market identifier" />
      </div>

      <div class="section-title">Position Parameters</div>

      <!-- Position Side -->
      <div class="form-group">
        <label class="form-label">Position Side *</label>
        <select id="side" class="form-select">
          <option value="long">Long (Buy Base with Quote)</option>
          <option value="short">Short (Sell Base for Quote)</option>
        </select>
      </div>

      <!-- Leverage Control -->
      <div class="form-group">
        <label class="form-label">Target Leverage <span id="leverageValue" class="leverage-badge" style="margin-left: 10px;">1.0x</span></label>
        <input type="range" id="leverageSlider" min="1" max="10" step="0.1" value="1" class="form-input" style="cursor: pointer;" oninput="updateLeverageFromSlider()" />
        <div style="display: flex; gap: 10px; margin-top: 8px;">
          <input type="number" id="leverageInput" min="1" max="10" step="0.1" value="1" class="form-input" placeholder="1.0" style="flex: 1;" oninput="updateLeverageFromInput()" />
          <button class="preset-btn" onclick="setLeverage(2)" style="flex: 0 0 60px;">2x</button>
          <button class="preset-btn" onclick="setLeverage(5)" style="flex: 0 0 60px;">5x</button>
          <button class="preset-btn" onclick="setLeverage(10)" style="flex: 0 0 60px;">10x</button>
        </div>
        <span class="form-help">Desired leverage for your position</span>
      </div>

      <!-- Quantity -->
      <div class="form-group">
        <label class="form-label">Quantity *</label>
        <input type="text" id="quantity" class="form-input" placeholder="0.0" oninput="calculateFromQuantity()" />
        <span class="form-help">Amount of base token for the position</span>
      </div>

      <!-- Limit Price -->
      <div class="form-group">
        <label class="form-label">Limit Price (optional)</label>
        <input type="text" id="limitPrice" class="form-input" placeholder="0.0" />
        <span class="form-help">Maximum acceptable price (0 for market price)</span>
      </div>

      <!-- Collateral Amount -->
      <div class="form-group">
        <label class="form-label">Collateral / Cashflow *</label>
        <div class="input-with-max">
          <input type="text" id="cashflow" class="form-input" placeholder="0.0" oninput="calculateFromCollateral()" />
          <button class="max-btn" onclick="setMaxCollateral()">MAX</button>
        </div>
        <span class="form-help">Amount of collateral to deposit for leverage</span>
      </div>

      <!-- Collateral Currency -->
      <div class="form-group">
        <label class="form-label">Collateral Currency</label>
        <select id="cashflowCcy" class="form-select" onchange="calculateFromQuantity(); checkAllowance();">
          <option value="0">Base Token</option>
          <option value="1">Quote Token</option>
        </select>
      </div>

      <!-- Position Metrics Dashboard -->
      <div id="metricsSection" class="hidden">
        <div class="section-title">Position Metrics <span id="leverageBadge" class="leverage-badge">--x</span></div>
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Leverage</div>
            <div id="leverageMetric" class="metric-value">--</div>
            <div class="metric-subtext">Position Size / Collateral</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Position Value</div>
            <div id="positionValueMetric" class="metric-value">--</div>
            <div class="metric-subtext">Total exposure</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">LTV Ratio</div>
            <div id="ltvMetric" class="metric-value">--</div>
            <div class="metric-subtext">Loan-to-Value</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Est. Liq. Price</div>
            <div id="liqPriceMetric" class="metric-value">--</div>
            <div class="metric-subtext">Approximate liquidation</div>
          </div>
        </div>
      </div>

      <!-- Token Approval Section -->
      <div id="approvalSection" class="approval-section hidden">
        <div style="font-size: 0.9rem; color: #ffc857; margin-bottom: 8px;">
          ‚ö†Ô∏è Token approval required before trading
        </div>
        <div style="font-size: 0.8rem; color: #8b93b5; margin-bottom: 10px;">
          You need to approve the Contango contract to spend your <span id="approvalTokenName">tokens</span>
        </div>
        <button id="approvalBtn" class="approval-btn" onclick="approveToken()">
          Approve <span id="approvalTokenSymbol">Token</span>
        </button>
      </div>

      <!-- Generated Symbol Preview -->
      <div class="alert alert-info">
        <strong>Generated Instrument Symbol:</strong>
        <div id="symbolPreview" style="margin-top: 8px; font-family: 'JetBrains Mono', monospace; font-size: 1rem;">
          Fill in fields to generate symbol
        </div>
      </div>

      <button id="submitBtn" class="submit-btn" onclick="openPosition()" disabled>
        Execute Trade
      </button>

      <!-- Error/Success Messages -->
      <div id="errorMsg" class="alert alert-error hidden"></div>
      <div id="successMsg" class="alert alert-success hidden"></div>
    </div>

    <!-- Example Section -->
    <div class="card" style="animation: slideIn 0.85s ease-out;">
      <h3 style="color: #00aaff; margin-bottom: 15px; font-size: 1.1rem;">üìù Multi-Chain Support</h3>

      <div class="example-box">
        <div style="margin-bottom: 12px; color: #00ffaa; font-weight: 600;">Supported Networks</div>
        <div style="margin-bottom: 8px;"><strong>‚Ä¢ Base:</strong> DAI/USDS loops, WETH/USDC, cbETH/USDC</div>
        <div style="margin-bottom: 8px;"><strong>‚Ä¢ Arbitrum One:</strong> WETH/USDC, WBTC/USDC, ARB/USDC</div>
        <div style="margin-bottom: 8px;"><strong>‚Ä¢ Optimism:</strong> WETH/USDC, OP/USDC</div>
        <div style="margin-bottom: 8px;"><strong>‚Ä¢ Polygon:</strong> WETH/USDC, WMATIC/USDC</div>
        <div style="margin-bottom: 8px;"><strong>‚Ä¢ Ethereum:</strong> WETH/USDC, WBTC/USDC</div>
        <div><strong>‚Ä¢ Avalanche:</strong> WAVAX/USDC, WETH/USDC</div>
      </div>

      <p style="margin-top: 15px; font-size: 0.85rem; color: #8b93b5;">
        üí° Tip: Select your network above, then use preset buttons to auto-fill popular token pairs!
      </p>
    </div>

    <!-- Contract Info -->
    <div class="info-card" id="contractInfo">
      <div><strong>Select a network to view contract details</strong></div>
    </div>

    <!-- Disclaimer -->
    <div class="disclaimer">
      ‚ö†Ô∏è Advanced users only. Verify all token addresses on the block explorer before trading. This UI charges no fees but understand the protocol mechanics before use.
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script type="module">
    import { createWeb3Modal, defaultConfig } from 'https://esm.sh/@web3modal/ethers5@3.5.0'

    // Make createWeb3Modal and defaultConfig globally available
    window.createWeb3Modal = createWeb3Modal;
    window.defaultConfig = defaultConfig;

    // Signal that Web3Modal is loaded
    window.web3ModalLoaded = true;
    window.dispatchEvent(new Event('web3modal-loaded'));
  </script>
  <script>
    // Wait for both ethers and Web3Modal to load
    let ethersReady = false;
    let web3ModalReady = false;
    let ethersCheckAttempts = 0;
    const MAX_ETHERS_CHECK_ATTEMPTS = 100; // 10 seconds max

    // Check if ethers is loaded
    function checkEthersReady() {
      ethersCheckAttempts++;

      if (typeof ethers !== 'undefined') {
        ethersReady = true;
        console.log('Ethers.js loaded successfully');
        checkAllReady();
      } else if (ethersCheckAttempts >= MAX_ETHERS_CHECK_ATTEMPTS) {
        console.error('Ethers.js failed to load after 10 seconds');
        // Show error and still proceed to prevent UI from being stuck
        window.dispatchEvent(new Event('app-load-failed'));
      } else {
        setTimeout(checkEthersReady, 100);
      }
    }

    // Check if Web3Modal is loaded
    window.addEventListener('web3modal-loaded', () => {
      web3ModalReady = true;
      console.log('Web3Modal loaded successfully');
      checkAllReady();
    });

    // Check if all dependencies are ready
    function checkAllReady() {
      if (ethersReady && web3ModalReady) {
        console.log('All dependencies loaded, initializing app...');
        window.dispatchEvent(new Event('app-ready'));
      }
    }

    // Handle load failure
    window.addEventListener('app-load-failed', () => {
      console.error('Critical libraries failed to load');
      const initMsg = document.getElementById('initializingMsg');
      const connectBtn = document.getElementById('connectBtn');

      if (initMsg) initMsg.classList.add('hidden');
      if (connectBtn) {
        connectBtn.disabled = false;
        connectBtn.textContent = 'Connect Wallet';
        connectBtn.classList.remove('loading');
      }

      // Show error with reload button
      const errorMsg = document.getElementById('errorMsg');
      if (errorMsg) {
        errorMsg.innerHTML = `
          <div style="margin-bottom: 10px;">Failed to load required libraries. This may be due to a network issue or content blocker.</div>
          <button class="approval-btn" onclick="window.location.reload()" style="margin-top: 10px;">
            Reload Page
          </button>
        `;
        errorMsg.classList.remove('hidden');
      }
    });

    // Start checking for ethers
    checkEthersReady();
  </script>
  <script>
    const CONTANGO_ABI = [
      "function trade(tuple(bytes32 symbol, address trader, uint256 quantity, int256 limitPrice, int256 cashflow, uint8 cashflowCcy) tradeParams) external payable returns (tuple(bytes32 positionId, address trader, uint256 openQuantity, uint256 openCost, int256 collateral, uint256 totalFees, int256 liquidationPrice))",
      "function multicall(bytes[] calldata data) external payable returns (bytes[] memory results)"
    ];

    const ERC20_ABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)",
      "function approve(address spender, uint256 amount) returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];

    // Network configuration - loaded from JSON
    let NETWORKS = {};
    let currentNetwork = null;
    let CONTANGO_PROXY = '';
    let PRESETS = {};

    let provider = null;
    let signer = null;
    let account = '';
    let walletName = '';
    let web3Modal = null;

    // Token info cache
    let baseTokenInfo = { balance: '0', decimals: 18, symbol: '', address: '' };
    let quoteTokenInfo = { balance: '0', decimals: 18, symbol: '', address: '' };
    let currentPrice = 1; // Approximate price (base/quote)

    // Load network configuration from JSON
    async function loadNetworks() {
      try {
        const response = await fetch('network-config.json');
        NETWORKS = await response.json();

        // Populate network selector
        const networkSelect = document.getElementById('networkSelect');
        networkSelect.innerHTML = '<option value="">Select Network...</option>';

        Object.keys(NETWORKS).forEach(networkKey => {
          const network = NETWORKS[networkKey];
          const option = document.createElement('option');
          option.value = networkKey;
          option.textContent = `${network.name} (Chain ${network.chainId})`;
          networkSelect.appendChild(option);
        });

        // Default to Base
        networkSelect.value = 'base';
        await switchNetwork();

      } catch (err) {
        console.error('Error loading networks:', err);
        showError('Failed to load network configuration');
      }
    }

    // Switch to selected network
    async function switchNetwork() {
      const networkKey = document.getElementById('networkSelect').value;

      if (!networkKey || !NETWORKS[networkKey]) {
        document.getElementById('networkInfo').textContent = 'Select a network to begin';
        document.getElementById('networkStatus').className = 'network-status disconnected';
        return;
      }

      currentNetwork = NETWORKS[networkKey];
      CONTANGO_PROXY = currentNetwork.contracts.maestroProxy;
      PRESETS = currentNetwork.presets || {};

      // Update network info display
      document.getElementById('networkInfo').textContent =
        `${currentNetwork.name} - Chain ID: ${currentNetwork.chainId}`;
      document.getElementById('networkStatus').className = 'network-status';

      // Update presets UI
      updatePresetsUI();

      // Update contract info display
      updateContractInfo();

      // Clear form when switching networks
      clearForm();

      // If wallet is connected, check if we need to switch network
      if (provider && account) {
        const network = await provider.getNetwork();
        if (network.chainId !== currentNetwork.chainId) {
          await promptNetworkSwitch();
        } else {
          // Reload token info if addresses are set
          const baseToken = document.getElementById('baseToken').value;
          const quoteToken = document.getElementById('quoteToken').value;
          if (baseToken && ethers.utils.isAddress(baseToken)) {
            loadTokenInfo('base');
          }
          if (quoteToken && ethers.utils.isAddress(quoteToken)) {
            loadTokenInfo('quote');
          }
        }
      }
    }

    // Prompt user to switch network in wallet
    async function promptNetworkSwitch() {
      if (!currentNetwork || !web3Modal) return;

      try {
        const walletProvider = web3Modal.getWalletProvider();
        if (!walletProvider) {
          showError('Please connect your wallet first');
          return;
        }

        await walletProvider.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: `0x${currentNetwork.chainId.toString(16)}` }],
        });

        // Reinitialize provider after network switch
        provider = new ethers.providers.Web3Provider(walletProvider, "any");
        signer = provider.getSigner();

        showSuccess(`Switched to ${currentNetwork.name}`);
      } catch (switchError) {
        // This error code indicates that the chain has not been added to the wallet
        if (switchError.code === 4902) {
          try {
            const walletProvider = web3Modal.getWalletProvider();
            await walletProvider.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: `0x${currentNetwork.chainId.toString(16)}`,
                chainName: currentNetwork.name,
                nativeCurrency: currentNetwork.nativeCurrency,
                rpcUrls: [currentNetwork.rpcUrl],
                blockExplorerUrls: [currentNetwork.explorerUrl]
              }]
            });
            provider = new ethers.providers.Web3Provider(walletProvider, "any");
            signer = provider.getSigner();
            showSuccess(`Added and switched to ${currentNetwork.name}`);
          } catch (addError) {
            showError('Failed to add network. Please add it manually.');
            return;
          }
        } else {
          showError('Failed to switch network: ' + switchError.message);
          return;
        }
      }
    }

    // Update presets UI based on current network
    function updatePresetsUI() {
      const presetButtonsContainer = document.querySelector('.preset-buttons');
      if (!presetButtonsContainer) return;

      presetButtonsContainer.innerHTML = '';

      // Add preset buttons for current network
      Object.keys(PRESETS).forEach(presetKey => {
        const button = document.createElement('button');
        button.className = 'preset-btn';
        button.textContent = PRESETS[presetKey].name;
        button.onclick = () => loadPreset(presetKey);
        presetButtonsContainer.appendChild(button);
      });

      // Add clear button
      const clearButton = document.createElement('button');
      clearButton.className = 'preset-btn';
      clearButton.textContent = 'Clear All';
      clearButton.onclick = clearForm;
      presetButtonsContainer.appendChild(clearButton);
    }

    // Update contract info display
    function updateContractInfo() {
      const contractInfoDiv = document.getElementById('contractInfo');
      if (!contractInfoDiv || !currentNetwork) return;

      contractInfoDiv.innerHTML = `
        <div><strong>Contract:</strong> ${currentNetwork.contracts.maestroProxy}</div>
        <div><strong>Network:</strong> ${currentNetwork.name} (Chain ID: ${currentNetwork.chainId})</div>
        <div><strong>Explorer:</strong> <a href="${currentNetwork.explorerUrl}" target="_blank" rel="noopener noreferrer" style="color: #00ffaa;">${currentNetwork.explorerUrl}</a></div>
        <div><strong>Function:</strong> trade() via multicall</div>
      `;
    }

    // Load preset configuration
    function loadPreset(presetKey) {
      const preset = PRESETS[presetKey];
      if (!preset) return;

      document.getElementById('baseToken').value = preset.baseToken;
      document.getElementById('quoteToken').value = preset.quoteToken;
      document.getElementById('moneyMarket').value = preset.moneyMarket;
      document.getElementById('side').value = preset.side;

      updateSymbolPreview();

      if (account) {
        loadTokenInfo('base');
        loadTokenInfo('quote');
      }

      showSuccess(`Loaded preset: ${preset.name} - ${preset.description}`);
      setTimeout(hideSuccess, 3000);
    }

    // Clear form
    function clearForm() {
      document.getElementById('baseToken').value = '';
      document.getElementById('quoteToken').value = '';
      document.getElementById('quantity').value = '';
      document.getElementById('cashflow').value = '';
      document.getElementById('limitPrice').value = '';
      document.getElementById('moneyMarket').value = '';
      document.getElementById('side').value = 'long';
      document.getElementById('cashflowCcy').value = '1';

      document.getElementById('baseBalance').classList.add('hidden');
      document.getElementById('quoteBalance').classList.add('hidden');
      document.getElementById('metricsSection').classList.add('hidden');
      document.getElementById('approvalSection').classList.add('hidden');

      baseTokenInfo = { balance: '0', decimals: 18, symbol: '', address: '' };
      quoteTokenInfo = { balance: '0', decimals: 18, symbol: '', address: '' };

      updateSymbolPreview();
    }

    // Load token information (balance, decimals, symbol)
    async function loadTokenInfo(tokenType) {
      if (!signer || !account) return;

      // Check if ethers is available
      if (typeof ethers === 'undefined') {
        console.warn('Ethers not loaded yet, cannot load token info');
        return;
      }

      try {
        const inputId = tokenType === 'base' ? 'baseToken' : 'quoteToken';
        const tokenAddress = document.getElementById(inputId).value.trim();

        if (!ethers.utils.isAddress(tokenAddress)) {
          return;
        }

        const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);

        const [balance, decimals, symbol] = await Promise.all([
          tokenContract.balanceOf(account),
          tokenContract.decimals(),
          tokenContract.symbol()
        ]);

        const formattedBalance = ethers.utils.formatUnits(balance, decimals);

        if (tokenType === 'base') {
          baseTokenInfo = { balance: formattedBalance, decimals, symbol, address: tokenAddress };
          const balanceDiv = document.getElementById('baseBalance');
          balanceDiv.querySelector('.balance-value').textContent = `${parseFloat(formattedBalance).toFixed(4)} ${symbol}`;
          balanceDiv.classList.remove('hidden');
        } else {
          quoteTokenInfo = { balance: formattedBalance, decimals, symbol, address: tokenAddress };
          const balanceDiv = document.getElementById('quoteBalance');
          balanceDiv.querySelector('.balance-value').textContent = `${parseFloat(formattedBalance).toFixed(4)} ${symbol}`;
          balanceDiv.classList.remove('hidden');

          // Check allowance for quote token
          await checkAllowance();
        }

        calculateMetrics();

      } catch (err) {
        console.error('Error loading token info:', err);
      }
    }

    // Check token allowance
    async function checkAllowance() {
      if (!signer || !account) return;

      // Check if ethers is available
      if (typeof ethers === 'undefined') {
        console.warn('Ethers not loaded yet, cannot check allowance');
        return;
      }

      try {
        const cashflow = document.getElementById('cashflow').value || '0';
        const cashflowCcy = document.getElementById('cashflowCcy').value;

        // Determine which token needs approval
        let tokenInfo, tokenAddress;
        if (cashflowCcy === '0') {
          // Base token
          if (!baseTokenInfo.address) return;
          tokenInfo = baseTokenInfo;
          tokenAddress = baseTokenInfo.address;
        } else {
          // Quote token
          if (!quoteTokenInfo.address) return;
          tokenInfo = quoteTokenInfo;
          tokenAddress = quoteTokenInfo.address;
        }

        if (parseFloat(cashflow) > 0) {
          const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
          const allowance = await tokenContract.allowance(account, CONTANGO_PROXY);
          const cashflowWei = ethers.utils.parseUnits(cashflow, tokenInfo.decimals);

          if (allowance.lt(cashflowWei)) {
            // Need approval
            document.getElementById('approvalTokenName').textContent = tokenInfo.symbol;
            document.getElementById('approvalTokenSymbol').textContent = tokenInfo.symbol;
            document.getElementById('approvalSection').classList.remove('hidden');
            document.getElementById('approvalSection').dataset.tokenAddress = tokenAddress;
            document.getElementById('approvalSection').dataset.tokenDecimals = tokenInfo.decimals;
            document.getElementById('approvalSection').dataset.tokenSymbol = tokenInfo.symbol;
          } else {
            document.getElementById('approvalSection').classList.add('hidden');
          }
        } else {
          document.getElementById('approvalSection').classList.add('hidden');
        }
      } catch (err) {
        console.error('Error checking allowance:', err);
      }
    }

    // Approve token
    async function approveToken() {
      const approvalSection = document.getElementById('approvalSection');
      const tokenAddress = approvalSection.dataset.tokenAddress;
      const tokenSymbol = approvalSection.dataset.tokenSymbol;

      if (!signer || !tokenAddress) {
        showError('Please connect wallet and select token');
        return;
      }

      try {
        const approvalBtn = document.getElementById('approvalBtn');
        approvalBtn.disabled = true;
        approvalBtn.textContent = 'Approving...';

        const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);

        // Approve max uint256 for convenience
        const maxApproval = ethers.constants.MaxUint256;
        const tx = await tokenContract.approve(CONTANGO_PROXY, maxApproval);

        const explorerUrl = currentNetwork ? currentNetwork.explorerUrl : 'https://basescan.org';
        showSuccess(`
          <div class="tx-label">APPROVAL SUBMITTED</div>
          <a href="${explorerUrl}/tx/${tx.hash}" target="_blank" rel="noopener noreferrer" class="tx-link">
            ${tx.hash}
          </a>
          <div style="margin-top: 10px; font-size: 0.85rem;">Waiting for confirmation...</div>
        `);

        await tx.wait();

        approvalSection.classList.add('hidden');
        showSuccess(`${tokenSymbol} approved! You can now execute your trade.`);
        return true;

      } catch (err) {
        console.error('Approval error:', err);
        let errorMsg = 'Approval failed: ';
        if (err.code === 4001) {
          errorMsg += 'Transaction rejected by user';
        } else {
          errorMsg += err.message || err.toString();
        }
        showError(errorMsg);
        return false;
      } finally {
        const approvalBtn = document.getElementById('approvalBtn');
        approvalBtn.disabled = false;
        approvalBtn.textContent = `Approve ${tokenSymbol}`;
      }
    }

    // Leverage calculation functions
    function updateLeverageFromSlider() {
      const leverage = parseFloat(document.getElementById('leverageSlider').value);
      document.getElementById('leverageInput').value = leverage.toFixed(1);
      document.getElementById('leverageValue').textContent = `${leverage.toFixed(1)}x`;

      // Recalculate collateral based on leverage
      const quantity = parseFloat(document.getElementById('quantity').value) || 0;
      if (quantity > 0) {
        const positionValue = quantity * currentPrice;
        const requiredCollateral = positionValue / leverage;
        const cashflowCcy = document.getElementById('cashflowCcy').value;
        const collateralValue = cashflowCcy === '0' ? requiredCollateral / currentPrice : requiredCollateral;
        document.getElementById('cashflow').value = collateralValue.toFixed(6);
      }

      calculateMetrics();
    }

    function updateLeverageFromInput() {
      const leverage = parseFloat(document.getElementById('leverageInput').value);
      if (leverage >= 1 && leverage <= 10) {
        document.getElementById('leverageSlider').value = leverage;
        document.getElementById('leverageValue').textContent = `${leverage.toFixed(1)}x`;

        // Recalculate collateral based on leverage
        const quantity = parseFloat(document.getElementById('quantity').value) || 0;
        if (quantity > 0) {
          const positionValue = quantity * currentPrice;
          const requiredCollateral = positionValue / leverage;
          const cashflowCcy = document.getElementById('cashflowCcy').value;
          const collateralValue = cashflowCcy === '0' ? requiredCollateral / currentPrice : requiredCollateral;
          document.getElementById('cashflow').value = collateralValue.toFixed(6);
        }

        calculateMetrics();
      }
    }

    function setLeverage(value) {
      document.getElementById('leverageSlider').value = value;
      document.getElementById('leverageInput').value = value;
      document.getElementById('leverageValue').textContent = `${value}.0x`;

      // Recalculate collateral based on leverage
      const quantity = parseFloat(document.getElementById('quantity').value) || 0;
      if (quantity > 0) {
        const positionValue = quantity * currentPrice;
        const requiredCollateral = positionValue / value;
        const cashflowCcy = document.getElementById('cashflowCcy').value;
        const collateralValue = cashflowCcy === '0' ? requiredCollateral / currentPrice : requiredCollateral;
        document.getElementById('cashflow').value = collateralValue.toFixed(6);
      }

      calculateMetrics();
    }

    function calculateFromQuantity() {
      const quantity = parseFloat(document.getElementById('quantity').value) || 0;
      const leverage = parseFloat(document.getElementById('leverageSlider').value) || 1;

      if (quantity > 0) {
        const positionValue = quantity * currentPrice;
        const requiredCollateral = positionValue / leverage;
        const cashflowCcy = document.getElementById('cashflowCcy').value;
        const collateralValue = cashflowCcy === '0' ? requiredCollateral / currentPrice : requiredCollateral;
        document.getElementById('cashflow').value = collateralValue.toFixed(6);
      }

      calculateMetrics();
    }

    function calculateFromCollateral() {
      const cashflow = parseFloat(document.getElementById('cashflow').value) || 0;
      const cashflowCcy = document.getElementById('cashflowCcy').value;
      const quantity = parseFloat(document.getElementById('quantity').value) || 0;

      if (quantity > 0 && cashflow > 0) {
        const positionValue = quantity * currentPrice;
        const collateralValue = cashflowCcy === '0' ? cashflow * currentPrice : cashflow;
        const calculatedLeverage = positionValue / collateralValue;

        if (calculatedLeverage >= 1 && calculatedLeverage <= 10) {
          document.getElementById('leverageSlider').value = calculatedLeverage;
          document.getElementById('leverageInput').value = calculatedLeverage.toFixed(1);
          document.getElementById('leverageValue').textContent = `${calculatedLeverage.toFixed(1)}x`;
        }
      }

      calculateMetrics();
    }

    // Set max collateral
    function setMaxCollateral() {
      const cashflowCcy = document.getElementById('cashflowCcy').value;
      const maxBalance = cashflowCcy === '0' ? baseTokenInfo.balance : quoteTokenInfo.balance;

      if (parseFloat(maxBalance) > 0) {
        document.getElementById('cashflow').value = maxBalance;
        calculateFromCollateral();
        checkAllowance();
      }
    }

    // Calculate position metrics (leverage, LTV, etc.)
    function calculateMetrics() {
      const quantity = parseFloat(document.getElementById('quantity').value) || 0;
      const cashflow = parseFloat(document.getElementById('cashflow').value) || 0;
      const cashflowCcy = document.getElementById('cashflowCcy').value;

      if (quantity === 0 || cashflow === 0) {
        document.getElementById('metricsSection').classList.add('hidden');
        return;
      }

      // Estimate position value and leverage
      // For simplicity, assume base/quote price ratio
      // In production, you'd fetch real prices from an oracle or DEX

      const positionValue = quantity * currentPrice;
      const collateralValue = cashflowCcy === '0' ? cashflow * currentPrice : cashflow;

      const leverage = positionValue / collateralValue;
      const ltv = ((positionValue - collateralValue) / positionValue) * 100;

      // Estimate liquidation price (simplified)
      // Assume 80% LTV threshold for liquidation
      const liquidationLTV = 80;
      const liqPrice = currentPrice * (1 - (liquidationLTV - ltv) / 100);

      // Update UI
      document.getElementById('metricsSection').classList.remove('hidden');
      document.getElementById('leverageMetric').textContent = `${leverage.toFixed(2)}x`;

      // Update leverage badge in metrics section
      const metricBadge = document.getElementById('leverageBadge');
      if (metricBadge) {
        metricBadge.textContent = `${leverage.toFixed(1)}x`;
      }

      document.getElementById('positionValueMetric').textContent = `$${positionValue.toFixed(2)}`;

      const ltvElement = document.getElementById('ltvMetric');
      ltvElement.textContent = `${ltv.toFixed(1)}%`;
      ltvElement.className = 'metric-value';
      if (ltv > 70) ltvElement.classList.add('danger');
      else if (ltv > 50) ltvElement.classList.add('warning');

      const liqElement = document.getElementById('liqPriceMetric');
      if (liqPrice > 0) {
        liqElement.textContent = `$${liqPrice.toFixed(2)}`;
      } else {
        liqElement.textContent = 'N/A';
      }

      checkAllowance();
    }

    // Update symbol preview when inputs change
    document.addEventListener('DOMContentLoaded', () => {
      ['baseToken', 'quoteToken', 'moneyMarket', 'side'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updateSymbolPreview);
          element.addEventListener('change', updateSymbolPreview);
        }
      });

      document.getElementById('moneyMarket').addEventListener('change', (e) => {
        const customSection = document.getElementById('customMarketSection');
        if (e.target.value === 'custom') {
          customSection.classList.remove('hidden');
        } else {
          customSection.classList.add('hidden');
        }
      });
    });

    function updateSymbolPreview() {
      const baseToken = document.getElementById('baseToken').value;
      const quoteToken = document.getElementById('quoteToken').value;
      const moneyMarket = document.getElementById('moneyMarket').value;
      const side = document.getElementById('side').value;

      if (baseToken && quoteToken && moneyMarket) {
        // This is a simplified symbol generation
        // In reality, Contango has a specific format that includes the market ID
        const baseShort = baseToken.substring(2, 8).toUpperCase();
        const quoteShort = quoteToken.substring(2, 8).toUpperCase();
        const marketId = moneyMarket === 'custom' ? document.getElementById('customMarketId').value : moneyMarket.toUpperCase();
        const symbol = `${baseShort}${quoteShort}-${marketId}`;
        document.getElementById('symbolPreview').textContent = symbol;
      } else {
        document.getElementById('symbolPreview').textContent = 'Fill in fields to generate symbol';
      }
    }

    // Initialize Web3Modal
    async function initWeb3Modal() {
      try {
        // Wait for Web3Modal to be available with timeout
        const timeout = 10000; // 10 seconds
        const startTime = Date.now();

        while (!window.createWeb3Modal || !window.defaultConfig) {
          if (Date.now() - startTime > timeout) {
            throw new Error('Web3Modal failed to load. Please refresh the page.');
          }
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        const projectId = '3fbb6bba6f1de962d911bb5b5c9ddd26'; // WalletConnect project ID

        // Configure metadata
        const metadata = {
          name: 'Contango Direct Interface',
          description: 'Custom Position Builder for Contango',
          url: window.location.origin,
          icons: ['https://avatars.githubusercontent.com/u/37784886']
        };

        // Get all available chains from NETWORKS
        const chains = Object.values(NETWORKS).map(network => ({
          chainId: network.chainId,
          name: network.name,
          currency: network.nativeCurrency.symbol,
          explorerUrl: network.explorerUrl,
          rpcUrl: network.rpcUrl
        }));

        const ethersConfig = window.defaultConfig({
          metadata,
          enableEIP6963: true,
          enableInjected: true,
          enableCoinbase: true,
          rpcUrl: 'https://mainnet.base.org',
          defaultChainId: 8453
        });

        web3Modal = window.createWeb3Modal({
          ethersConfig,
          chains,
          projectId,
          enableAnalytics: false,
          themeMode: 'dark',
          themeVariables: {
            '--w3m-accent': '#00ffaa',
            '--w3m-border-radius-master': '10px'
          }
        });

        console.log('Web3Modal initialized successfully');

        // Subscribe to connection events
        web3Modal.subscribeProvider(async (newState) => {
          console.log('Provider state changed:', newState);
          if (newState.isConnected && newState.address) {
            await handleWalletConnected(newState);
          } else if (!newState.isConnected) {
            handleWalletDisconnected();
          }
        });

        // Check if already connected
        const state = web3Modal.getState();
        if (state.isConnected && state.address) {
          console.log('Wallet already connected, restoring connection...');
          await handleWalletConnected(state);
        }

        return true;
      } catch (err) {
        console.error('Error initializing Web3Modal:', err);
        showError('Failed to initialize wallet connection: ' + err.message);
        return false;
      }
    }

    async function handleWalletConnected(state) {
      try {
        const walletProvider = web3Modal.getWalletProvider();
        if (!walletProvider) {
          showError('Unable to get wallet provider');
          return;
        }

        // Check if ethers is available
        if (typeof ethers === 'undefined') {
          showError('Ethers library not loaded. Please refresh the page.');
          return;
        }

        provider = new ethers.providers.Web3Provider(walletProvider, "any");
        signer = provider.getSigner();
        account = state.address;

        // Detect wallet type
        walletName = 'Web3 Wallet';
        if (walletProvider.isMetaMask) walletName = 'MetaMask';
        if (walletProvider.isRabby) walletName = 'Rabby';
        if (walletProvider.isCoinbaseWallet) walletName = 'Coinbase Wallet';
        if (walletProvider.isWalletConnect) walletName = 'WalletConnect';

        const network = await provider.getNetwork();
        console.log('Connected to network:', network.chainId, 'Account:', account);

        // Get native balance
        try {
          const balance = await provider.getBalance(account);
          const formattedBalance = ethers.utils.formatEther(balance);
          const nativeCurrency = currentNetwork ? currentNetwork.nativeCurrency.symbol : 'ETH';
          document.getElementById('walletBalance').textContent =
            `Balance: ${parseFloat(formattedBalance).toFixed(4)} ${nativeCurrency}`;
        } catch (balanceErr) {
          console.error('Error loading balance:', balanceErr);
          document.getElementById('walletBalance').textContent = 'Balance: --';
        }

        // Check if on correct network
        if (currentNetwork && network.chainId !== currentNetwork.chainId) {
          showError(`Please switch to ${currentNetwork.name} in your wallet or click below to switch`);

          // Add a button to switch network
          const errorMsg = document.getElementById('errorMsg');
          const switchButton = document.createElement('button');
          switchButton.className = 'approval-btn';
          switchButton.textContent = `Switch to ${currentNetwork.name}`;
          switchButton.style.marginTop = '10px';
          switchButton.onclick = promptNetworkSwitch;
          errorMsg.appendChild(switchButton);

          document.getElementById('submitBtn').disabled = true;
        } else {
          document.getElementById('submitBtn').disabled = false;
          hideError();
        }

        document.getElementById('walletAddress').textContent = formatAddress(account);
        document.getElementById('walletType').textContent = walletName;
        document.getElementById('connectSection').classList.add('hidden');
        document.getElementById('walletSection').classList.remove('hidden');

        // Reset connect button state if still visible
        const connectBtn = document.querySelector('.connect-btn');
        if (connectBtn) {
          connectBtn.disabled = false;
          connectBtn.textContent = 'Connect Wallet';
          connectBtn.classList.remove('loading');
        }

        // Show success message
        showSuccess(`Connected to ${walletName}!`);
        setTimeout(hideSuccess, 3000);

        // Listen for network changes
        if (walletProvider.on) {
          walletProvider.on('chainChanged', async (chainId) => {
            console.log('Network changed to:', chainId);
            // Reload the page to reset state
            window.location.reload();
          });

          walletProvider.on('accountsChanged', async (accounts) => {
            console.log('Accounts changed:', accounts);
            if (accounts.length === 0) {
              // User disconnected
              handleWalletDisconnected();
            } else {
              // Account changed - reload to reset state
              window.location.reload();
            }
          });
        }

        // Load token info if addresses are already filled
        const baseToken = document.getElementById('baseToken').value;
        const quoteToken = document.getElementById('quoteToken').value;
        if (baseToken && ethers.utils.isAddress(baseToken)) {
          loadTokenInfo('base');
        }
        if (quoteToken && ethers.utils.isAddress(quoteToken)) {
          loadTokenInfo('quote');
        }
      } catch (err) {
        console.error('Error handling wallet connection:', err);
        showError('Failed to connect wallet: ' + (err.message || err.toString()));
      }
    }

    function handleWalletDisconnected() {
      provider = null;
      signer = null;
      account = '';
      walletName = '';

      document.getElementById('connectSection').classList.remove('hidden');
      document.getElementById('walletSection').classList.add('hidden');
      document.getElementById('submitBtn').disabled = true;
      hideError();
      hideSuccess();
    }

    async function connectWallet() {
      const connectBtn = document.querySelector('.connect-btn');
      if (!connectBtn) return;

      const originalText = connectBtn.textContent;

      try {
        hideError();
        hideSuccess();

        // Show loading state
        connectBtn.disabled = true;
        connectBtn.textContent = 'Connecting...';
        connectBtn.classList.add('loading');

        if (!currentNetwork) {
          showError('Please select a network first');
          throw new Error('No network selected');
        }

        if (!web3Modal) {
          showError('Wallet connection is initializing, please try again in a moment');
          throw new Error('Web3Modal not initialized');
        }

        console.log('Opening Web3Modal...');
        await web3Modal.open();

        // Note: The actual connection happens in the subscribeProvider callback
        // The button will be re-enabled once the wallet section is shown
      } catch (err) {
        console.error('Error opening wallet modal:', err);

        // Only show error if not already shown
        const errorMsg = document.getElementById('errorMsg');
        if (errorMsg && !errorMsg.classList.contains('hidden')) {
          // Error already shown, don't overwrite it
        } else {
          showError('Failed to open wallet selector: ' + (err.message || err.toString()));
        }

        // Always re-enable button on error
        connectBtn.disabled = false;
        connectBtn.textContent = originalText;
        connectBtn.classList.remove('loading');
      }
    }

    async function disconnectWallet() {
      try {
        if (web3Modal) {
          await web3Modal.disconnect();
        }
        handleWalletDisconnected();
      } catch (err) {
        console.error('Error disconnecting wallet:', err);
        handleWalletDisconnected(); // Force disconnect UI even on error
      }
    }

    // Initialize when all dependencies are ready
    window.addEventListener('app-ready', async () => {
      console.log('Initializing application...');

      // Show initializing message
      const initMsg = document.getElementById('initializingMsg');
      const connectBtn = document.getElementById('connectBtn');
      if (initMsg) initMsg.classList.remove('hidden');
      if (connectBtn) connectBtn.disabled = true;

      try {
        // Load networks first
        await loadNetworks();

        // Initialize Web3Modal
        const success = await initWeb3Modal();

        if (success) {
          console.log('Application initialized successfully');
          // Hide initializing message and enable connect button
          if (initMsg) initMsg.classList.add('hidden');
          if (connectBtn) connectBtn.disabled = false;
        } else {
          throw new Error('Web3Modal initialization failed');
        }
      } catch (err) {
        console.error('Initialization error:', err);
        showError('Failed to initialize application: ' + err.message);

        // Still hide the message and show the button in case of error
        if (initMsg) initMsg.classList.add('hidden');
        if (connectBtn) {
          connectBtn.disabled = false;
          connectBtn.textContent = 'Retry Connection';
        }
      }
    });

    async function openPosition() {
      try {
        hideError();
        hideSuccess();

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';
        submitBtn.classList.add('loading');

        // Check if ethers is available
        if (typeof ethers === 'undefined') {
          throw new Error('Ethers library not loaded. Please refresh the page and try again.');
        }

        // Comprehensive wallet and network checks
        if (!signer || !provider || !account) {
          throw new Error('Please connect your wallet');
        }

        if (!currentNetwork) {
          throw new Error('Please select a network');
        }

        if (!CONTANGO_PROXY) {
          throw new Error('Contract address not configured for this network');
        }

        // Verify we're on the correct network
        const network = await provider.getNetwork();
        if (network.chainId !== currentNetwork.chainId) {
          throw new Error(`Please switch to ${currentNetwork.name} (Chain ID: ${currentNetwork.chainId})`);
        }

        console.log('Opening position with:', {
          account,
          network: network.chainId,
          contract: CONTANGO_PROXY
        });

        // Check if approval is needed first
        const cashflow = document.getElementById('cashflow').value;
        const cashflowCcy = document.getElementById('cashflowCcy').value;

        if (parseFloat(cashflow) > 0) {
          // Determine which token we're using for collateral
          const tokenInfo = cashflowCcy === '0' ? baseTokenInfo : quoteTokenInfo;
          const tokenAddress = tokenInfo.address;

          if (!tokenAddress) {
            throw new Error('Please select valid token addresses');
          }

          // Check current allowance
          const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
          const allowance = await tokenContract.allowance(account, CONTANGO_PROXY);
          const cashflowWei = ethers.utils.parseUnits(cashflow, tokenInfo.decimals);

          // If insufficient allowance, request approval first
          if (allowance.lt(cashflowWei)) {
            submitBtn.textContent = 'Approving token...';
            showSuccess(`Approval needed for ${tokenInfo.symbol}. Please approve in your wallet.`);

            const approvalResult = await approveToken();
            if (!approvalResult) {
              throw new Error('Approval required to proceed with trade');
            }

            // Wait a moment for the approval to be indexed
            await new Promise(resolve => setTimeout(resolve, 2000));
            submitBtn.textContent = 'Executing trade...';
          }
        }

        // Get form values
        const baseToken = document.getElementById('baseToken').value.trim();
        const quoteToken = document.getElementById('quoteToken').value.trim();
        const moneyMarket = document.getElementById('moneyMarket').value;
        const quantity = document.getElementById('quantity').value;
        const side = document.getElementById('side').value;
        const limitPrice = document.getElementById('limitPrice').value;

        // Validate inputs
        if (!baseToken || !quoteToken || !moneyMarket || !quantity) {
          throw new Error('Please fill in all required fields');
        }

        if (!ethers.utils.isAddress(baseToken)) {
          throw new Error('Invalid base token address');
        }

        if (!ethers.utils.isAddress(quoteToken)) {
          throw new Error('Invalid quote token address');
        }

        // Generate instrument symbol
        // Format: BASE-QUOTE-MARKET (this is simplified - real format may vary)
        const marketId = moneyMarket === 'custom' ? 
          document.getElementById('customMarketId').value : 
          moneyMarket.toUpperCase();
        
        // Create a symbol from the addresses and market
        // Contango uses a specific format - this is an approximation
        const symbolString = `${baseToken.substring(2, 10)}-${quoteToken.substring(2, 10)}-${marketId}`.toUpperCase();
        const symbolBytes32 = ethers.utils.formatBytes32String(symbolString);
        
        // Determine decimals for conversion
        const baseDecimals = baseTokenInfo.decimals || 18;
        const quoteDecimals = quoteTokenInfo.decimals || 18;
        const cashflowDecimals = cashflowCcy === '0' ? baseDecimals : quoteDecimals;

        const contract = new ethers.Contract(CONTANGO_PROXY, CONTANGO_ABI, signer);

        // Convert values with proper decimals
        const quantityWei = ethers.utils.parseUnits(quantity, baseDecimals);
        const limitPriceWei = limitPrice ? ethers.utils.parseUnits(limitPrice, 18) : 0;
        const cashflowWei = cashflow ? ethers.utils.parseUnits(cashflow, cashflowDecimals) : 0;

        const tradeParams = {
          symbol: symbolBytes32,
          trader: account,
          quantity: quantityWei,
          limitPrice: limitPriceWei,
          cashflow: cashflowWei,
          cashflowCcy: parseInt(cashflowCcy)
        };

        const tx = await contract.trade(tradeParams);

        const explorerUrl = currentNetwork ? currentNetwork.explorerUrl : 'https://basescan.org';
        showSuccess(`
          <div class="tx-label">TRANSACTION SUBMITTED</div>
          <a href="${explorerUrl}/tx/${tx.hash}" target="_blank" rel="noopener noreferrer" class="tx-link">
            ${tx.hash}
          </a>
          <div style="margin-top: 10px; font-size: 0.85rem;">Waiting for confirmation...</div>
        `);

        await tx.wait();

        showSuccess(`
          <div class="tx-label">POSITION OPENED!</div>
          <a href="${explorerUrl}/tx/${tx.hash}" target="_blank" rel="noopener noreferrer" class="tx-link">
            ${tx.hash}
          </a>
          <div style="margin-top: 10px; font-size: 0.85rem;">Your custom position is now active.</div>
        `);

      } catch (err) {
        console.error('Error:', err);
        const friendlyError = getUserFriendlyError(err);
        showError('Transaction failed: ' + friendlyError);
      } finally {
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Execute Trade';
        submitBtn.classList.remove('loading');
      }
    }

    function formatAddress(addr) {
      if (!addr) return '';
      return `${addr.slice(0, 6)}...${addr.slice(-4)}`;
    }

    function copyAddress() {
      if (!account) return;

      navigator.clipboard.writeText(account).then(() => {
        // Visual feedback
        const copyBtn = event.target;
        const originalText = copyBtn.textContent;
        copyBtn.textContent = '‚úì';
        copyBtn.style.background = 'rgba(0, 255, 170, 0.3)';

        setTimeout(() => {
          copyBtn.textContent = originalText;
          copyBtn.style.background = '';
        }, 1500);

        showSuccess('Address copied to clipboard!');
        setTimeout(hideSuccess, 2000);
      }).catch(err => {
        console.error('Failed to copy address:', err);
        showError('Failed to copy address');
      });
    }

    // Get user-friendly error message
    function getUserFriendlyError(error) {
      if (!error) return 'An unknown error occurred';

      const message = error.message || error.toString();

      // Common error patterns and their user-friendly messages
      if (message.includes('user rejected') || message.includes('User denied') || error.code === 4001) {
        return 'Transaction cancelled by user';
      }

      if (message.includes('insufficient funds')) {
        return 'Insufficient funds in your wallet';
      }

      if (message.includes('network') || message.includes('Network')) {
        return 'Network error. Please check your connection and try again.';
      }

      if (message.includes('nonce')) {
        return 'Transaction error. Please try again or reset your wallet.';
      }

      if (message.includes('gas')) {
        return 'Gas estimation failed. You may not have enough funds or the transaction may fail.';
      }

      if (message.includes('ethers is not defined') || message.includes('Ethers library not loaded')) {
        return `
          <div>Failed to load required libraries.</div>
          <button class="approval-btn" onclick="window.location.reload()" style="margin-top: 10px;">
            Reload Page
          </button>
        `;
      }

      // Return original message if no match
      return message;
    }

    function showError(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.innerHTML = message;
      errorMsg.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('errorMsg').classList.add('hidden');
    }

    function showSuccess(message) {
      const successMsg = document.getElementById('successMsg');
      successMsg.innerHTML = message;
      successMsg.classList.remove('hidden');
    }

    function hideSuccess() {
      document.getElementById('successMsg').classList.add('hidden');
    }
  </script>
</body>
</html>
